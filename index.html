<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ç‡ƒçƒ§ç‹ | è‡ªåŠ¨å¯¹é½ç»ˆç»“ç‰ˆ</title>
<script src="https://cdn.bootcdn.net/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif}
  body{background:#0a0a0a;color:#fff;padding:15px}
  .card{background:#121212;border-radius:20px;padding:22px;margin:15px 0;border:1px solid #222}
  .logo{font-size:22px;font-weight:700;color:#ff3d3d;text-align:center;margin-bottom:10px}
  #connectBtn{background:#ff3d3d;color:#fff;border:none;padding:12px;border-radius:12px;width:100%;font-weight:700;cursor:pointer}
  .status-row{display:flex;justify-content:space-between;margin-bottom:10px;font-size:13px;color:#aaa}
  .main-btn{width:100%;background:#ff3d3d;color:#fff;border:none;padding:18px;border-radius:16px;font-weight:700;cursor:pointer;margin-top:10px}
  .main-btn:disabled{background:#333;color:#888;cursor:not-allowed}
  .debug-box{background:#000;padding:12px;border-radius:10px;font-family:monospace;font-size:11px;color:#00ff00;margin-top:15px;max-height:150px;overflow-y:auto;border:1px solid #333}
  .highlight{color:#ff3d3d;font-weight:700}
</style>
</head>
<body>
<div class="container" style="max-width:480px;margin:0 auto">
  <div class="logo">ğŸ”¥ ç‡ƒçƒ§ç‹ç³»ç»Ÿ (è‡ªåŠ¨å¯¹é½)</div>
  <button id="connectBtn" onclick="connectWallet()">1. è¿æ¥é’±åŒ… (è‡ªåŠ¨å¯¹é½å½“å‰åœ°å€)</button>

  <div class="card">
    <div class="status-row"><span>å½“å‰æ“ä½œè´¦å·:</span><span id="userAddr" class="highlight">æœªè¿æ¥</span></div>
    <div class="status-row"><span>è´¦æˆ·ä»£å¸ä½™é¢:</span><span id="balShow" class="highlight">--</span></div>
  </div>

  <div class="card">
    <p style="font-size:12px;color:#888">ç¬¬ä¸€æ­¥ï¼šç»‘å®š (è‹¥å·²ç»‘è¯·è·³è¿‡)</p>
    <input type="text" id="inviter" placeholder="é‚€è¯·äººåœ°å€" style="width:100%;padding:14px;background:#1a1a1a;color:#fff;border:1px solid #333;border-radius:10px;margin-top:8px">
    <button class="main-btn" onclick="doBind()">æ‰§è¡Œç»‘å®š</button>
  </div>

  <div class="card">
    <p style="font-size:12px;color:#888">ç¬¬äºŒæ­¥ï¼šæˆæƒ (ç‡ƒçƒ§å‰å¿…ç‚¹ä¸€æ¬¡)</p>
    <button class="main-btn" onclick="doApprove()" style="background:#222;border:1px solid #444">å¼€å¯ç‡ƒçƒ§æƒé™</button>
    
    <p style="font-size:12px;color:#888;margin-top:20px">ç¬¬ä¸‰æ­¥ï¼šç‡ƒçƒ§ (è¾“å…¥æ•°é‡æ‰£æ¬¾)</p>
    <input type="number" id="amt" placeholder="è¾“å…¥ç‡ƒçƒ§æ•°é‡" style="width:100%;padding:14px;background:#1a1a1a;color:#fff;border:1px solid #333;border-radius:10px;margin-top:8px">
    <button class="main-btn" onclick="doBurn()">ç¡®è®¤ç‡ƒçƒ§æ‰£æ¬¾</button>
  </div>

  <div class="debug-box" id="log">> ç³»ç»Ÿå°±ç»ªã€‚</div>
</div>

<script>
// ================= ä¸¥æ ¼åˆ†å·¥é…ç½® =================
const CONFIG = {
  chainId: 56,
  token: "0x1382992c4f997a21256be58dc546e9937a5f7777", // è´Ÿè´£ä½™é¢
  logic: "0xe3115d9dad43e47e9ae54d3cef1001aa34d8e602"  // è´Ÿè´£ä¸šåŠ¡
};

const ABI = ["function balanceOf(address) view returns (uint256)","function approve(address, uint256) returns (bool)","function burn(uint256)","function bindInviter(address)"];

let signer, user, tokenC, logicC;

// ã€æ ¸å¿ƒï¼šè‡ªåŠ¨å¯¹é½ç›‘å¬å™¨ã€‘
if (window.ethereum) {
  // ç›‘å¬è´¦å·åˆ‡æ¢ï¼šä¸€æ—¦ä½ åœ¨é’±åŒ…Appé‡Œåˆ‡æ¢è´¦å·ï¼Œç½‘é¡µç«‹åˆ»åˆ·æ–°å¯¹é½
  window.ethereum.on('accountsChanged', (accounts) => {
    console.log("æ£€æµ‹åˆ°è´¦å·åˆ‡æ¢ï¼Œæ­£åœ¨è‡ªåŠ¨å¯¹é½...");
    window.location.reload();
  });
  // ç›‘å¬é“¾åˆ‡æ¢
  window.ethereum.on('chainChanged', () => window.location.reload());
}

function log(msg, hash = null) {
  const b = document.getElementById('log');
  let content = `<br>> ${msg}`;
  if(hash) content += `<br><a href="https://bscscan.com/tx/${hash}" target="_blank" style="color:#90caf9;font-size:10px">[é“¾ä¸Šå‡­è¯: ${hash.slice(0,10)}...]</a>`;
  b.innerHTML += content;
  b.scrollTop = b.scrollHeight;
}

async function connectWallet() {
  if (!window.ethereum) return alert('è¯·åœ¨é’±åŒ…å†…æ‰“å¼€');
  const p = new ethers.providers.Web3Provider(window.ethereum);
  await p.send("eth_requestAccounts", []);
  signer = p.getSigner();
  user = await signer.getAddress();
  
  tokenC = new ethers.Contract(CONFIG.token, ABI, signer);
  logicC = new ethers.Contract(CONFIG.logic, ABI, signer);
  
  // UIå¯¹é½æ˜¾ç¤º
  document.getElementById('userAddr').textContent = user.slice(0,6)+"..."+user.slice(-4);
  document.getElementById('connectBtn').textContent = "å·²è¿æ¥å½“å‰åœ°å€";
  log(`åœ°å€å¯¹é½æˆåŠŸ: ${user}`);
  refresh();
}

async function refresh() {
  try {
    const b = await tokenC.balanceOf(user);
    document.getElementById('balShow').textContent = ethers.utils.formatUnits(b, 18);
  } catch (e) { log("æ•°æ®åŒæ­¥å¼‚å¸¸"); }
}

async function doBind() {
  try {
    log("æäº¤ç»‘å®šè¯·æ±‚...");
    const tx = await logicC.bindInviter(document.getElementById('inviter').value);
    await tx.wait();
    log("âœ… ç»‘å®šæˆåŠŸï¼", tx.hash);
  } catch (e) { log("âŒ ç»‘å®šå¤±è´¥: å¯èƒ½å·²ç»‘å®š"); }
}

async function doApprove() {
  try {
    log("æäº¤æˆæƒè¯·æ±‚ (Approve)...");
    const tx = await tokenC.approve(CONFIG.logic, ethers.constants.MaxUint256);
    await tx.wait();
    log("âœ… æˆæƒå®Œæˆï¼å·²å¼€å¯ç‡ƒçƒ§æƒé™ã€‚", tx.hash);
  } catch (e) { log("âŒ æˆæƒå¤±è´¥"); }
}

async function doBurn() {
  const v = document.getElementById('amt').value;
  if(!v) return log("è¯·è¾“å…¥æ•°é‡");
  try {
    log(`æäº¤ç‡ƒçƒ§æ‰£æ¬¾: ${v}...`);
    // æ‰§è¡Œç‡ƒçƒ§å‡½æ•°
    const tx = await logicC.burn(ethers.utils.parseUnits(v.toString(), 18));
    log("äº¤æ˜“å·²ä¸Šé“¾ï¼Œç­‰å¾…ç¡®è®¤...", tx.hash);
    const r = await tx.wait();
    if(r.status === 1) {
      log("ğŸ”¥ ç‡ƒçƒ§æˆåŠŸï¼ä½™é¢å·²æ›´æ–°ã€‚");
      refresh();
    }
  } catch (e) { 
    log("âŒ ç‡ƒçƒ§å¤±è´¥: æ£€æŸ¥æˆæƒæˆ–ä½™é¢"); 
    console.error(e);
  }
}
</script>
</body>
</html>