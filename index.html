<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ç‡ƒçƒ§ç‹ | æ·±åº¦è°ƒè¯•ç‰ˆ</title>
<script src="https://cdn.bootcdn.net/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif}
  body{background:#0a0a0a;color:#fff;padding:15px}
  .card{background:#121212;border-radius:20px;padding:20px;margin:15px 0;border:1px solid #222}
  .logo{color:#ff3d3d;text-align:center;font-weight:700;margin-bottom:10px}
  #connectBtn{background:#ff3d3d;color:#fff;border:none;padding:12px;border-radius:12px;width:100%;cursor:pointer}
  .status-tag{font-size:12px;padding:3px 8px;border-radius:5px;float:right}
  .tag-off{background:#333;color:#888}
  .tag-on{background:#153a25;color:#81c784}
  input{width:100%;background:#1a1a1a;border:1px solid #333;border-radius:12px;padding:14px;color:#fff;margin:10px 0}
  .main-btn{width:100%;background:#ff3d3d;color:#fff;border:none;padding:16px;border-radius:14px;font-weight:700;cursor:pointer;margin-top:10px}
  .debug-log{background:#000;padding:12px;border-radius:10px;font-family:monospace;font-size:11px;color:#00ff00;margin-top:15px;max-height:150px;overflow-y:auto;border:1px solid #333}
</style>
</head>
<body>
<div class="container">
  <div class="logo">ğŸ”¥ ç‡ƒçƒ§ç‹ç³»ç»Ÿ | æ·±åº¦æ£€æµ‹</div>
  <button id="connectBtn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>

  <div class="card">
    <h3>ç»‘å®šæ£€æµ‹ <span id="bindTag" class="status-tag tag-off">æœªæ£€æµ‹</span></h3>
    <p id="inviterShow" style="font-size:11px;color:#666;margin-top:5px">å½“å‰ä¸Šçº§ï¼šæœªçŸ¥</p>
    <input type="text" id="inviterInput" placeholder="è¾“å…¥éé¡¹ç›®æ–¹é‚€è¯·åœ°å€">
    <button class="main-btn" onclick="tryBind()">æ‰§è¡Œå¼ºåŠ›ç»‘å®š</button>
  </div>

  <div class="card">
    <p>è´¦æˆ·ä½™é¢: <strong id="balanceShow">--</strong></p>
    <input type="number" id="burnAmount" placeholder="ç‡ƒçƒ§æ•°é‡">
    <button class="main-btn" onclick="approve()" style="background:#222">1. æˆæƒ (Approve)</button>
    <button class="main-btn" onclick="burn()">2. ç¡®è®¤ç‡ƒçƒ§ (Burn)</button>
  </div>

  <div class="debug-log" id="debugLog">> è¯·è¿æ¥é’±åŒ…å¯åŠ¨æ£€æµ‹...</div>
</div>

<script>
const CONFIG = {
  chainId: 56,
  tokenAddr: "0x1382992c4f997a21256be58dc546e9937a5f7777",
  logicAddr: "0xe3115d9dad43e47e9ae54d3cef1001aa34d8e602" 
};

// æ¢æµ‹å¤šç§å¯èƒ½çš„å‡½æ•°å
const ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function approve(address, uint256) returns (bool)",
  "function burn(uint256)",
  "function bindInviter(address)",
  "function addInviter(address)", // å¤‡é€‰
  "function setInviter(address)", // å¤‡é€‰
  "function inviter(address) view returns (address)",
  "function inviters(address) view returns (address)", // å¤‡é€‰
  "function getInviter(address) view returns (address)" // å¤‡é€‰
];

let signer, userAddress, tokenContract, logicContract;

function log(msg) {
  const box = document.getElementById('debugLog');
  box.innerHTML += `<br>> ${msg}`;
  box.scrollTop = box.scrollHeight;
}

async function connectWallet() {
  if (!window.ethereum) return alert('è¯·åœ¨é’±åŒ…å†…æ‰“å¼€');
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  userAddress = await signer.getAddress();
  tokenContract = new ethers.Contract(CONFIG.tokenAddr, ABI, signer);
  logicContract = new ethers.Contract(CONFIG.logicAddr, ABI, signer);
  log(`é’±åŒ…å·²è¿æ¥: ${userAddress.slice(0,10)}...`);
  refresh();
}

async function refresh() {
  try {
    const bal = await tokenContract.balanceOf(userAddress);
    document.getElementById('balanceShow').textContent = ethers.utils.formatUnits(bal, 18);
    
    // å¼ºåŠ›æ¢æµ‹ç»‘å®šçŠ¶æ€
    let parent = "0x0000000000000000000000000000000000000000";
    try {
      parent = await logicContract.inviter(userAddress);
    } catch(e) {
      try { parent = await logicContract.inviters(userAddress); } 
      catch(e2) { try { parent = await logicContract.getInviter(userAddress); } catch(e3) { log("æ— æ³•è¯†åˆ«åˆçº¦æŸ¥è¯¢å‡½æ•°"); } }
    }

    const tag = document.getElementById('bindTag');
    if (parent !== "0x0000000000000000000000000000000000000000") {
      tag.textContent = "å·²ç»‘å®š"; tag.className = "status-tag tag-on";
      document.getElementById('inviterShow').textContent = "ä¸Šçº§: " + parent;
      log("æ£€æµ‹åˆ°å·²ç»‘å®šä¸Šçº§");
    } else {
      tag.textContent = "æœªç»‘å®š"; tag.className = "status-tag tag-off";
      log("æ£€æµ‹ç»“æœ: æ‚¨å°šæœªç»‘å®šä¸Šçº§");
    }
  } catch (e) { log("çŠ¶æ€åˆ·æ–°å¼‚å¸¸ï¼Œè¯·æ ¸å¯¹é€»è¾‘åˆçº¦åœ°å€"); }
}

async function tryBind() {
  const addr = document.getElementById('inviterInput').value;
  if (!ethers.utils.isAddress(addr)) return log("åœ°å€æ ¼å¼é”™è¯¯");
  
  log("å°è¯•æ‰§è¡Œç»‘å®š...");
  try {
    // å°è¯•ç¬¬ä¸€ç§å‘½å
    const tx = await logicContract.bindInviter(addr);
    await tx.wait();
    log("âœ… ç»‘å®šæˆåŠŸ (æ–¹å¼1)");
    refresh();
  } catch (e) {
    try {
      log("æ–¹å¼1å¤±è´¥ï¼Œå°è¯•æ–¹å¼2...");
      const tx = await logicContract.addInviter(addr);
      await tx.wait();
      log("âœ… ç»‘å®šæˆåŠŸ (æ–¹å¼2)");
      refresh();
    } catch(e2) {
      log("âŒ ç»‘å®šä¾ç„¶è¢«æ‹’ã€‚åŸå› : " + (e2.reason || "åˆçº¦å†…éƒ¨æŠ¥é”™ï¼Œå¯èƒ½å·²ç»‘å®šæˆ–åœ°å€å—é™"));
    }
  }
}

async function approve() {
  try {
    log("å‘èµ·æˆæƒ...");
    const tx = await tokenContract.approve(CONFIG.logicAddr, ethers.constants.MaxUint256);
    await tx.wait();
    log("âœ… æˆæƒæˆåŠŸ");
  } catch (e) { log("âŒ æˆæƒå¤±è´¥"); }
}

async function burn() {
  const val = document.getElementById('burnAmount').value;
  try {
    log("æ‰§è¡Œç‡ƒçƒ§...");
    const tx = await logicContract.burn(ethers.utils.parseUnits(val.toString(), 18));
    await tx.wait();
    log("ğŸ”¥ ç‡ƒçƒ§æˆåŠŸï¼");
    refresh();
  } catch (e) { log("âŒ ç‡ƒçƒ§å¤±è´¥: è¯·ç¡®ä¿å·²ç»‘å®šä¸”å·²æˆæƒ"); }
}
</script>
</body>
</html>