<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ç‡ƒçƒ§ç‹ğŸ”¥ğŸ”¥ğŸ”¥ | BSCç‡ƒçƒ§åˆ†çº¢DApp</title>
<script src="https://cdn.bootcdn.net/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:"PingFang SC","Microsoft YaHei",sans-serif}
  body{background:#0a0a0a;color:#fff;padding:15px}
  .container{max-width:480px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;padding:18px 0;border-bottom:1px solid #222}
  .logo{font-size:24px;font-weight:700;color:#ff3d3d}
  button{transition: all 0.2s ease;}
  button:disabled{background:#333 !important; color:#888 !important; cursor:not-allowed !important;}
  #connectBtn{background:#ff3d3d;color:#fff;border:none;padding:11px 18px;border-radius:12px;font-weight:700;cursor:pointer}
  .card{background:#121212;border-radius:20px;padding:24px;margin:16px 0;border:1px solid #222}
  .card h3{color:#ff3d3d;margin-bottom:18px;font-size:18px}
  .balance{color:#aaa;margin-bottom:12px; display:flex; justify-content:space-between;}
  input{width:100%;background:#1a1a1a;border:1px solid #333;border-radius:14px;padding:16px;color:#fff;font-size:16px;outline:0;margin-bottom:10px}
  .main-btn{width:100%;background:#ff3d3d;color:#fff;border:none;padding:16px;border-radius:14px;font-weight:700;cursor:pointer;margin-top:5px}
  .invite-box{margin-top:15px; padding:15px; background:#1a1a1a; border-radius:14px; border:1px dashed #444;}
  .copy-btn{background:#333; color:#fff; padding:10px; border-radius:10px; border:none; width:100%; margin-top:10px; font-size:12px; cursor:pointer;}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid-item{background:#1a1a1a;padding:16px;border-radius:12px}
  .grid-item strong{color:#ff3d3d;font-size:16px; display:block; margin-top:4px;}
  .status{margin-top:16px;padding:12px;border-radius:10px;text-align:center; display:none; font-size:13px; word-break: break-all;}
  .status.info{background:#132a45;color:#90caf9; display:block;}
  .status.success{background:#153a25;color:#81c784; display:block;}
  .status.error{background:#3a1518;color:#e57373; display:block;}
</style>
</head>
<body>
<div class="container">
<header>
  <div class="logo">ç‡ƒçƒ§ç‹ğŸ”¥ğŸ”¥ğŸ”¥</div>
  <button id="connectBtn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
</header>

<div class="card">
  <h3>ğŸ”¥ ç‡ƒçƒ§é”€æ¯ Â· å…¨ç½‘åˆ†çº¢</h3>
  <div class="balance"><span id="balanceTxt">ä½™é¢ï¼š--</span></div>
  <input type="number" id="burnAmount" placeholder="è¾“å…¥ç‡ƒçƒ§æ•°é‡">
  <button class="main-btn" id="approveBtn" onclick="approve()">1. æˆæƒ (Approve)</button>
  <button class="main-btn" id="burnBtn" onclick="burn()" style="margin-top:10px;">2. ç¡®è®¤ç‡ƒçƒ§ (Burn)</button>
  <div id="status" class="status"></div>
</div>

<div class="card">
  <h3>ğŸ‘¥ é‚€è¯·ç»‘å®š (å¿…å¡«)</h3>
  <input type="text" id="inviter" placeholder="è¾“å…¥é‚€è¯·äººåœ°å€ (0x...)">
  <button class="main-btn" id="bindBtn" onclick="bindInviter()">ç¡®è®¤ç»‘å®šé‚€è¯·äºº</button>
  
  <div class="invite-box">
      <p style="font-size:12px; color:#aaa; margin-bottom:8px;">æ‚¨çš„ä¸“å±é‚€è¯·é“¾æ¥ï¼š</p>
      <code id="myLinkDisplay" style="font-size:11px; color:#ff3d3d; word-break:break-all;">è¿æ¥é’±åŒ…åæŸ¥çœ‹</code>
      <button class="copy-btn" onclick="copyLink()">ä¸€é”®å¤åˆ¶æˆ‘çš„é“¾æ¥</button>
  </div>
</div>

<div class="card">
  <h3>ğŸ“Š å…¨ç½‘æ•°æ®</h3>
  <div class="grid">
    <div class="grid-item">æ€»ç‡ƒçƒ§<strong id="totalBurn">--</strong></div>
    <div class="grid-item">ç‡ƒçƒ§äººæ•°<strong id="burnUsers">--</strong></div>
    <div class="grid-item">æˆ‘çš„åˆ†çº¢<strong id="myReward">-- BNB</strong></div>
  </div>
  <button class="main-btn" onclick="claim()" style="margin-top:15px; background:#444;">é¢†å–åˆ†çº¢</button>
</div>
</div>

<script>
// ================= æ›´æ–°åçš„åˆçº¦é…ç½® =================
const CONFIG = {
  chainId: 56,
  tokenAddress: "0x9e649831fd15b1563c292d25af9aee3285f37777" // å·²æ›´æ¢ä¸ºæ–°æä¾›çš„åœ°å€
};

// ABI ä¿æŒä¸å˜ï¼ŒåŒ…å« DApp ä¸šåŠ¡åŠŸèƒ½
const ABI = [
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address, address) view returns (uint256)",
  "function approve(address, uint256) returns (bool)",
  "function burn(uint256)",
  "function bindInviter(address)",
  "function claimRewards()",
  "function totalBurned() view returns (uint256)",
  "function burnerCount() view returns (uint256)",
  "function pendingRewards(address) view returns (uint256)"
];

let provider, signer, userAddress, contract;

window.onload = () => {
  const params = new URLSearchParams(window.location.search);
  const ref = params.get('ref');
  if (ref && ethers.utils.isAddress(ref)) {
    document.getElementById('inviter').value = ref;
  }
};

function showStatus(text, type) {
  const s = document.getElementById('status');
  s.textContent = text;
  s.className = 'status ' + type;
}

async function connectWallet() {
  if (!window.ethereum) return showStatus('è¯·åœ¨é’±åŒ…æµè§ˆå™¨å†…æ‰“å¼€', 'error');
  try {
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    provider = new ethers.providers.Web3Provider(window.ethereum);
    const net = await provider.getNetwork();
    if (net.chainId !== 56) return showStatus('è¯·åˆ‡æ¢åˆ°BSCä¸»ç½‘', 'error');
    
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    contract = new ethers.Contract(CONFIG.tokenAddress, ABI, signer);
    
    document.getElementById('connectBtn').textContent = userAddress.slice(0,6)+'...';
    document.getElementById('myLinkDisplay').textContent = window.location.origin + window.location.pathname + "?ref=" + userAddress;
    
    refresh();
  } catch (e) { showStatus('è¿æ¥å¤±è´¥', 'error'); }
}

async function refresh() {
  if (!contract) return;
  try {
    const [bal, total, users, pending] = await Promise.all([
      contract.balanceOf(userAddress).catch(() => 0),
      contract.totalBurned().catch(() => 0),
      contract.burnerCount().catch(() => 0),
      contract.pendingRewards(userAddress).catch(() => 0)
    ]);
    document.getElementById('balanceTxt').textContent = `ä½™é¢ï¼š${ethers.utils.formatUnits(bal, 18)}`;
    document.getElementById('totalBurn').textContent = ethers.utils.formatUnits(total, 18);
    document.getElementById('burnUsers').textContent = users.toString();
    document.getElementById('myReward').textContent = ethers.utils.formatEther(pending) + ' BNB';
  } catch (e) { console.warn("æ•°æ®åŒæ­¥å¤±è´¥"); }
}

async function approve() {
  const btn = document.getElementById('approveBtn');
  try {
    btn.disabled = true;
    showStatus('æ­£åœ¨è¯·æ±‚æˆæƒ...', 'info');
    const tx = await contract.approve(CONFIG.tokenAddress, ethers.constants.MaxUint256);
    await tx.wait();
    showStatus('æˆæƒæˆåŠŸï¼', 'success');
  } catch (e) { 
    showStatus('æˆæƒå¤±è´¥: ' + (e.reason || 'äº¤æ˜“å–æ¶ˆ'), 'error'); 
  } finally { btn.disabled = false; }
}

async function burn() {
  const btn = document.getElementById('burnBtn');
  const val = document.getElementById('burnAmount').value;
  if (!val || val <= 0) return showStatus('è¯·è¾“å…¥ç‡ƒçƒ§æ•°é‡', 'error');
  try {
    btn.disabled = true;
    showStatus('æ­£åœ¨å‘é€ç‡ƒçƒ§è¯·æ±‚...', 'info');
    const tx = await contract.burn(ethers.utils.parseUnits(val.toString(), 18));
    await tx.wait();
    showStatus('ç‡ƒçƒ§æˆåŠŸ', 'success');
    refresh();
  } catch (e) { 
    showStatus('ç‡ƒçƒ§å¤±è´¥: ' + (e.reason || 'åˆçº¦æ‹’ç»ã€‚è¯·ç¡®è®¤å·²ç»‘å®šé‚€è¯·äºº'), 'error'); 
  } finally { btn.disabled = false; }
}

async function bindInviter() {
  const btn = document.getElementById('bindBtn');
  const addr = document.getElementById('inviter').value.trim();
  if (!ethers.utils.isAddress(addr)) return showStatus('è¯·è¾“å…¥æœ‰æ•ˆçš„é‚€è¯·äººåœ°å€', 'error');
  try {
    btn.disabled = true;
    showStatus('æ­£åœ¨å‘èµ·ç»‘å®šè¯·æ±‚...', 'info');
    const tx = await contract.bindInviter(addr);
    await tx.wait();
    showStatus('ç»‘å®šæˆåŠŸï¼', 'success');
  } catch (e) { 
    const msg = e.reason || (e.data && e.data.message) || e.message;
    showStatus('ç»‘å®šå¤±è´¥: ' + msg, 'error'); 
  } finally { btn.disabled = false; }
}

async function claim() {
  try {
    showStatus('æ­£åœ¨é¢†å–åˆ†çº¢...', 'info');
    const tx = await contract.claimRewards();
    await tx.wait();
    showStatus('é¢†å–æˆåŠŸ', 'success');
    refresh();
  } catch (e) { showStatus('é¢†å–å¤±è´¥', 'error'); }
}

function copyLink() {
  const link = document.getElementById('myLinkDisplay').textContent;
  const textArea = document.createElement("textarea");
  textArea.value = link;
  textArea.style.position = "fixed";
  textArea.style.left = "-9999px";
  document.body.appendChild(textArea);
  textArea.select();
  try {
    document.execCommand('copy');
    showStatus('é‚€è¯·é“¾æ¥å·²å¤åˆ¶', 'success');
  } catch (err) { alert("è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰é¡µé¢çº¢å­—é“¾æ¥è¿›è¡Œå¤åˆ¶"); }
  document.body.removeChild(textArea);
}
</script>
</body>
</html>