<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ç‡ƒçƒ§ç‹ğŸ”¥ğŸ”¥ğŸ”¥ | BSCç‡ƒçƒ§åˆ†çº¢DApp</title>
<script src="https://cdn.bootcdn.net/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:"PingFang SC","Microsoft YaHei",sans-serif}
  body{background:#0a0a0a;color:#fff;padding:15px}
  .container{max-width:480px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;padding:18px 0;border-bottom:1px solid #222}
  .logo{font-size:24px;font-weight:700;color:#ff3d3d}
  button{transition: all 0.2s ease;}
  button:disabled{background:#333 !important; color:#888 !important; cursor:not-allowed !important;}
  #connectBtn{background:#ff3d3d;color:#fff;border:none;padding:11px 18px;border-radius:12px;font-weight:700;cursor:pointer}
  .card{background:#121212;border-radius:20px;padding:24px;margin:16px 0;border:1px solid #222}
  .card h3{color:#ff3d3d;margin-bottom:18px;font-size:18px}
  .balance{color:#aaa;margin-bottom:12px; display:flex; justify-content:space-between;}
  input{width:100%;background:#1a1a1a;border:1px solid #333;border-radius:14px;padding:16px;color:#fff;font-size:16px;outline:0;margin-bottom:10px}
  input:focus{border-color:#ff3d3d}
  .quick{display:flex;gap:8px;margin-bottom:12px}
  .quick button{flex:1;background:#222;color:#fff;border:none;padding:12px;border-radius:10px;cursor:pointer}
  .quick button:hover{background:#333}
  .btn-group{display:flex;gap:10px;margin-top:10px}
  .main-btn{flex:1;background:#ff3d3d;color:#fff;border:none;padding:16px;border-radius:14px;font-weight:700;cursor:pointer}
  .warn{color:#ffbb00;font-size:12px;margin-top:10px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid-item{background:#1a1a1a;padding:16px;border-radius:12px}
  .grid-item strong{color:#ff3d3d;font-size:16px; display:block; margin-top:4px;}
  .status{margin-top:16px;padding:12px;border-radius:10px;text-align:center; display:none;}
  .status.info{background:#132a45;color:#90caf9; display:block;}
  .status.success{background:#153a25;color:#81c784; display:block;}
  .status.error{background:#3a1518;color:#e57373; display:block;}
</style>
</head>
<body>
<div class="container">
<header>
  <div class="logo">ç‡ƒçƒ§ç‹ğŸ”¥ğŸ”¥ğŸ”¥</div>
  <button id="connectBtn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
</header>

<div class="card">
  <h3>ğŸ”¥ ç‡ƒçƒ§é”€æ¯ Â· å…¨ç½‘åˆ†çº¢</h3>
  <div class="balance">
      <span id="balanceTxt">ä½™é¢ï¼š--</span>
      <span id="symbolTxt"></span>
  </div>
  <input type="number" id="burnAmount" placeholder="è¾“å…¥ç‡ƒçƒ§æ•°é‡" min="0">
  <div class="quick">
    <button onclick="setQuick(10)">10%</button>
    <button onclick="setQuick(50)">50%</button>
    <button onclick="setQuick(100)">MAX</button>
  </div>
  <div class="btn-group">
    <button class="main-btn" id="approveBtn" onclick="approve()">1. æˆæƒ</button>
    <button class="main-btn" id="burnBtn" onclick="burn()">2. ç¡®è®¤ç‡ƒçƒ§</button>
  </div>
  <div class="warn">âš ï¸ ç‡ƒçƒ§å‰è¯·ç¡®ä¿å·²ç»‘å®šé‚€è¯·äººã€‚ç‡ƒçƒ§åä»£å¸æ°¸ä¹…é”€æ¯ã€‚</div>
  <div id="status" class="status"></div>
</div>

<div class="card">
  <h3>ğŸ‘¥ é‚€è¯·ç»‘å®š (å¿…å¡«)</h3>
  <input type="text" id="inviter" placeholder="è¾“å…¥é‚€è¯·äººåœ°å€ (0x...)">
  <button class="main-btn" id="bindBtn" onclick="bindInviter()" style="width:100%;">ç»‘å®šé‚€è¯·äºº</button>
  <p style="color:#aaa; font-size:12px; margin-top:8px;">æç¤ºï¼šå¦‚æœä½ æ˜¯é€šè¿‡é‚€è¯·é“¾æ¥è®¿é—®çš„ï¼Œä¸Šæ–¹åœ°å€å·²è‡ªåŠ¨å¡«å…¥ã€‚</p >
</div>

<div class="card">
  <h3>ğŸ“Š å…¨ç½‘æ•°æ®</h3>
  <div class="grid">
    <div class="grid-item">æ€»ç‡ƒçƒ§<strong id="totalBurn">--</strong></div>
    <div class="grid-item">ç‡ƒçƒ§äººæ•°<strong id="burnUsers">--</strong></div>
    <div class="grid-item">ä»Šæ—¥ç‡ƒçƒ§<strong id="todayBurn">--</strong></div>
    <div class="grid-item">æˆ‘çš„åˆ†çº¢<strong id="myReward">-- BNB</strong></div>
  </div>
  <button class="main-btn" id="claimBtn" onclick="claim()" style="width:100%;margin-top:16px">é¢†å–åˆ†çº¢</button>
</div>

</div>

<script>
// ====================== æ ¸å¿ƒé…ç½® ======================
const CONFIG = {
  chainId: 56, // BSC ä¸»ç½‘æ•°å­—ID
  tokenAddress: "0xe8803797e060a45cdf5b45249c3316da5bd87777" // å·²æ›´æ¢ä¸ºæ–°åˆçº¦åœ°å€
};

// ABI ç²¾ç®€ç‰ˆ (ä»…åŒ…å«ç”¨åˆ°çš„å‡½æ•°)
const ABI = [
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)",
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address, address) view returns (uint256)",
  "function approve(address, uint256) returns (bool)",
  "function burn(uint256)",
  "function bindInviter(address)",
  "function claimRewards()",
  "function totalBurned() view returns (uint256)",
  "function todayBurn() view returns (uint256)",
  "function burnerCount() view returns (uint256)",
  "function pendingRewards(address) view returns (uint256)"
];
// ======================================================

let provider, signer, userAddress, contract;
let tokenDecimals = 18; // é»˜è®¤18ï¼Œè¿æ¥åè¦†ç›–
let rawBalance = ethers.BigNumber.from(0);

const UI = {
  status: document.getElementById('status'),
  connectBtn: document.getElementById('connectBtn'),
  approveBtn: document.getElementById('approveBtn'),
  burnBtn: document.getElementById('burnBtn'),
  bindBtn: document.getElementById('bindBtn'),
  claimBtn: document.getElementById('claimBtn')
};

// åˆå§‹åŒ–ï¼šè¯»å–URLå‚æ•°å¹¶è‡ªåŠ¨å¡«å……é‚€è¯·äºº
window.onload = () => {
  const urlParams = new URLSearchParams(window.location.search);
  const refAddress = urlParams.get('ref');
  if (refAddress && ethers.utils.isAddress(refAddress)) {
      document.getElementById('inviter').value = refAddress;
  }
};

function showStatus(text, type) {
  UI.status.textContent = text;
  UI.status.className = 'status ' + type;
}

// ç»Ÿä¸€çš„æŒ‰é’®åŠ è½½çŠ¶æ€ç®¡ç†ï¼ˆé˜²è¿ç‚¹ï¼‰
function setLoading(btn, isLoading, originalText) {
  if (isLoading) {
      btn.disabled = true;
      btn.dataset.text = btn.textContent;
      btn.textContent = "å¤„ç†ä¸­...";
  } else {
      btn.disabled = false;
      btn.textContent = originalText || btn.dataset.text;
  }
}

async function connectWallet() {
  if (!window.ethereum) return showStatus('è¯·åœ¨TokenPocketæˆ–MetaMaskç­‰é’±åŒ…å†…æ‰“å¼€', 'error');
  
  try {
    setLoading(UI.connectBtn, true);
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    provider = new ethers.providers.Web3Provider(window.ethereum);
    
    const network = await provider.getNetwork();
    if (network.chainId !== CONFIG.chainId) {
        throw new Error('è¯·åˆ‡æ¢åˆ°BSCä¸»ç½‘ (Binance Smart Chain)');
    }

    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    contract = new ethers.Contract(CONFIG.tokenAddress, ABI, signer);
    
    // åŠ¨æ€è·å–ç²¾åº¦å’Œç¬¦å·
    try {
        tokenDecimals = await contract.decimals();
        document.getElementById('symbolTxt').textContent = await contract.symbol();
    } catch(e) { console.warn("æ— æ³•è¯»å–ä»£å¸ä¿¡æ¯ï¼Œä½¿ç”¨é»˜è®¤å€¼"); }

    UI.connectBtn.textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
    showStatus('é’±åŒ…è¿æ¥æˆåŠŸ', 'success');
    refreshData();
  } catch (err) {
    showStatus(err.message || 'è¿æ¥å¤±è´¥', 'error');
    setLoading(UI.connectBtn, false, "è¿æ¥é’±åŒ…");
  }
}

async function refreshData() {
  if (!contract) return;
  try {
    rawBalance = await contract.balanceOf(userAddress);
    document.getElementById('balanceTxt').textContent = `ä½™é¢ï¼š${parseFloat(ethers.utils.formatUnits(rawBalance, tokenDecimals)).toFixed(4)}`;
    
    const [total, today, users, pending] = await Promise.all([
        contract.totalBurned().catch(()=>0),
        contract.todayBurn().catch(()=>0),
        contract.burnerCount().catch(()=>0),
        contract.pendingRewards(userAddress).catch(()=>0)
    ]);

    document.getElementById('totalBurn').textContent = ethers.utils.formatUnits(total, tokenDecimals);
    document.getElementById('todayBurn').textContent = ethers.utils.formatUnits(today, tokenDecimals);
    document.getElementById('burnUsers').textContent = users.toString();
    document.getElementById('myReward').textContent = parseFloat(ethers.utils.formatEther(pending)).toFixed(6) + ' BNB';
  } catch (e) {
    console.error("åŒæ­¥æ•°æ®å¤±è´¥", e);
  }
}

function setQuick(percent) {
  if (rawBalance.isZero()) return;
  const val = rawBalance.mul(percent).div(100);
  document.getElementById('burnAmount').value = ethers.utils.formatUnits(val, tokenDecimals);
}

async function checkAllowance(amountBN) {
    const allowance = await contract.allowance(userAddress, CONFIG.tokenAddress);
    return allowance.gte(amountBN);
}

async function approve() {
  if (!contract) return showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
  try {
    setLoading(UI.approveBtn, true);
    showStatus('æ­£åœ¨è¯·æ±‚æˆæƒ...', 'info');
    const tx = await contract.approve(CONFIG.tokenAddress, ethers.constants.MaxUint256);
    showStatus('ç­‰å¾…åŒºå—ç¡®è®¤...', 'info');
    await tx.wait();
    showStatus('æˆæƒæˆåŠŸï¼Œç°åœ¨å¯ä»¥ç‡ƒçƒ§äº†', 'success');
  } catch (e) {
    handleError(e);
  } finally {
    setLoading(UI.approveBtn, false, "1. æˆæƒ");
  }
}

async function burn() {
  if (!contract) return showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
  const input = document.getElementById('burnAmount').value;
  if (!input || parseFloat(input) <= 0) return showStatus('è¯·è¾“å…¥æ­£ç¡®çš„æ•°é‡', 'error');

  try {
    setLoading(UI.burnBtn, true);
    const amountBN = ethers.utils.parseUnits(input.toString(), tokenDecimals);
    
    // æ™ºèƒ½æ£€æŸ¥ï¼šå¦‚æœåˆçº¦è®¾è®¡æ˜¯ä»£æ‰£æ¨¡å¼ï¼Œæ£€æµ‹æˆæƒé¢åº¦
    // (å¦‚æœåˆçº¦æ˜¯ç›´æ¥é”€æ¯msg.senderä½™é¢æ¨¡å¼ï¼Œè¿™ä¸€æ­¥é€šå¸¸åˆçº¦ä¼šè‡ªåŠ¨æ”¾è¡Œ)
    const hasAllowance = await checkAllowance(amountBN);
    if (!hasAllowance) {
        showStatus('æˆæƒé¢åº¦ä¸è¶³ï¼Œè¯·å…ˆç‚¹å‡»ã€1. æˆæƒã€‘', 'error');
        setLoading(UI.burnBtn, false, "2. ç¡®è®¤ç‡ƒçƒ§");
        return;
    }

    showStatus('å‘é€ç‡ƒçƒ§è¯·æ±‚...', 'info');
    const tx = await contract.burn(amountBN);
    showStatus('ç­‰å¾…åŒºå—ç¡®è®¤...', 'info');
    await tx.wait();
    showStatus('ç‡ƒçƒ§æˆåŠŸï¼', 'success');
    refreshData();
  } catch (e) {
    handleError(e);
  } finally {
    setLoading(UI.burnBtn, false, "2. ç¡®è®¤ç‡ƒçƒ§");
  }
}

async function bindInviter() {
  if (!contract) return showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
  const inviter = document.getElementById('inviter').value.trim();
  if (!ethers.utils.isAddress(inviter)) return showStatus('æ— æ•ˆçš„é’±åŒ…åœ°å€', 'error');
  if (inviter.toLowerCase() === userAddress.toLowerCase()) return showStatus('ä¸èƒ½ç»‘å®šè‡ªå·±', 'error');

  try {
    setLoading(UI.bindBtn, true);
    showStatus('å‘é€ç»‘å®šè¯·æ±‚...', 'info');
    const tx = await contract.bindInviter(inviter);
    showStatus('ç­‰å¾…åŒºå—ç¡®è®¤...', 'info');
    await tx.wait();
    showStatus('ç»‘å®šæˆåŠŸï¼ç°åœ¨å¯ä»¥å»ç‡ƒçƒ§äº†', 'success');
  } catch (e) {
    handleError(e);
  } finally {
    setLoading(UI.bindBtn, false, "ç»‘å®šé‚€è¯·äºº");
  }
}

async function claim() {
  if (!contract) return showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
  try {
    setLoading(UI.claimBtn, true);
    showStatus('æ­£åœ¨é¢†å–åˆ†çº¢...', 'info');
    const tx = await contract.claimRewards();
    await tx.wait();
    showStatus('é¢†å–æˆåŠŸï¼è¯·æŸ¥çœ‹é’±åŒ…BNBä½™é¢', 'success');
    refreshData();
  } catch (e) {
    handleError(e);
  } finally {
    setLoading(UI.claimBtn, false, "é¢†å–åˆ†çº¢");
  }
}

// ç»Ÿä¸€é”™è¯¯å¤„ç†
function handleError(e) {
    console.error(e);
    if (e.code === 4001 || (e.message && e.message.includes('user rejected'))) {
        showStatus('ä½ å–æ¶ˆäº†äº¤æ˜“', 'error');
    } else if (e.message && e.message.includes('insufficient funds')) {
        showStatus('é’±åŒ…å†… BNB (Gasè´¹) ä¸è¶³', 'error');
    } else {
        showStatus('äº¤æ˜“å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ˜¯å¦å·²ç»‘å®šé‚€è¯·äººæˆ–ä½™é¢å……è¶³', 'error');
    }
}
</script>
</body>
</html>