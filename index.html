<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ç‡ƒçƒ§ç‹ | å·¥ä¸šçº§æœ€ç»ˆç‰ˆ</title>
<script src="https://cdn.bootcdn.net/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif}
  body{background:#0a0a0a;color:#fff;padding:15px}
  .container{max-width:480px;margin:0 auto}
  .card{background:#121212;border-radius:20px;padding:22px;margin:15px 0;border:1px solid #222}
  .logo{font-size:22px;font-weight:700;color:#ff3d3d;text-align:center;margin-bottom:10px}
  #connectBtn{background:#ff3d3d;color:#fff;border:none;padding:12px;border-radius:12px;width:100%;font-weight:700;cursor:pointer}
  .status-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;font-size:13px}
  .status-tag{padding:4px 10px;border-radius:8px;font-weight:700}
  .tag-off{background:#333;color:#888}
  .tag-on{background:#153a25;color:#81c784}
  input{width:100%;background:#1a1a1a;border:1px solid #333;border-radius:14px;padding:16px;color:#fff;font-size:16px;margin:10px 0}
  .main-btn{width:100%;background:#ff3d3d;color:#fff;border:none;padding:18px;border-radius:16px;font-weight:700;cursor:pointer;margin-top:10px}
  .debug-box{background:#000;padding:12px;border-radius:10px;font-family:monospace;font-size:11px;color:#00ff00;margin-top:15px;max-height:100px;overflow-y:auto;border:1px solid #333}
</style>
</head>
<body>
<div class="container">
  <div class="logo">ğŸ”¥ ç‡ƒçƒ§ç‹ Â· æ ¸å¿ƒç³»ç»Ÿ</div>
  <button id="connectBtn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>

  <div class="card">
    <div class="status-row">
      <span>ç»‘å®šçŠ¶æ€ï¼š</span>
      <span id="bindStatus" class="status-tag tag-off">æœªæ£€æµ‹</span>
    </div>
    <div class="status-row">
      <span>å½“å‰é‚€è¯·äººï¼š</span>
      <span id="inviterAddr" style="color:#aaa">--</span>
    </div>
    <input type="text" id="inviterInput" placeholder="è¾“å…¥é‚€è¯·äººåœ°å€ 0x...">
    <button class="main-btn" id="bindBtn" onclick="bindInviter()">æ‰§è¡Œç»‘å®š</button>
  </div>

  <div class="card">
    <div class="status-row"><span>è´¦æˆ·ä½™é¢ï¼š</span><strong id="balanceShow" style="font-size:18px">--</strong></div>
    <input type="number" id="burnAmount" placeholder="ç‡ƒçƒ§æ•°é‡">
    <button class="main-btn" onclick="approve()" style="background:#222;border:1px solid #444;font-size:14px">1. æˆæƒ (Approve)</button>
    <button class="main-btn" onclick="burn()">2. ç¡®è®¤ç‡ƒçƒ§ (Burn)</button>
  </div>

  <div class="card">
    <div class="status-row"><span>å¾…é¢†åˆ†çº¢ï¼š</span><strong id="rewardShow" style="color:#ff3d3d">-- BNB</strong></div>
    <button class="main-btn" onclick="claim()" style="background:#2a2a2a">é¢†å–åˆ†çº¢</button>
  </div>

  <div class="debug-box" id="debugLog">> ç³»ç»Ÿå°±ç»ªï¼Œè¯·è¿æ¥é’±åŒ…...</div>
</div>

<script>
// ================= ä¸¥æ ¼æ‰§è¡Œæ‚¨çš„åœ°å€åˆ†å·¥ =================
const CONFIG = {
  chainId: 56,
  tokenAddr: "0x1382992c4f997a21256be58dc546e9937a5f7777", // è´Ÿè´£ä½™é¢
  logicAddr: "0xe3115d9dad43e47e9ae54d3cef1001aa34d8e602"  // è´Ÿè´£ä¸šåŠ¡
};

const ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function approve(address, uint256) returns (bool)",
  "function burn(uint256)",
  "function bindInviter(address)",
  "function inviter(address) view returns (address)", // å…³é”®ï¼šæ¢æµ‹ç»‘å®šçŠ¶æ€
  "function pendingRewards(address) view returns (uint256)"
];

let signer, userAddress, tokenContract, logicContract;

function log(msg) {
  const box = document.getElementById('debugLog');
  box.innerHTML += `<br>> ${msg}`;
  box.scrollTop = box.scrollHeight;
}

async function connectWallet() {
  if (!window.ethereum) return alert('è¯·åœ¨é’±åŒ…å†…æ‰“å¼€');
  try {
    const provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    
    tokenContract = new ethers.Contract(CONFIG.tokenAddr, ABI, signer);
    logicContract = new ethers.Contract(CONFIG.logicAddr, ABI, signer);
    
    document.getElementById('connectBtn').textContent = userAddress.slice(0,6)+'...'+userAddress.slice(-4);
    log(`è¿æ¥æˆåŠŸ: ${userAddress}`);
    refresh();
  } catch (e) { log("è¿æ¥å¤±è´¥"); }
}

async function refresh() {
  try {
    // 1. æŸ¥ä½™é¢ (æ¥è‡ª Token åˆçº¦)
    const bal = await tokenContract.balanceOf(userAddress);
    document.getElementById('balanceShow').textContent = ethers.utils.formatUnits(bal, 18);
    
    // 2. æŸ¥ç»‘å®šçŠ¶æ€ (æ¥è‡ª Logic åˆçº¦)
    const currentInviter = await logicContract.inviter(userAddress);
    const bindTag = document.getElementById('bindStatus');
    const inviterAddrTxt = document.getElementById('inviterAddr');
    
    if (currentInviter !== "0x0000000000000000000000000000000000000000") {
      bindTag.textContent = "å·²ç»‘å®š";
      bindTag.className = "status-tag tag-on";
      inviterAddrTxt.textContent = currentInviter.slice(0,10) + "...";
      document.getElementById('inviterInput').disabled = true;
      document.getElementById('bindBtn').disabled = true;
      document.getElementById('bindBtn').style.opacity = "0.5";
    } else {
      bindTag.textContent = "æœªç»‘å®š";
      bindTag.className = "status-tag tag-off";
    }

    // 3. æŸ¥åˆ†çº¢
    const reward = await logicContract.pendingRewards(userAddress).catch(()=>0);
    document.getElementById('rewardShow').textContent = ethers.utils.formatEther(reward) + ' BNB';
    log("æ•°æ®å·²æ›´æ–°");
  } catch (e) { log("çŠ¶æ€åˆ·æ–°å¼‚å¸¸"); }
}

async function approve() {
  try {
    log("æ­£åœ¨å‘ä»£å¸åˆçº¦è¯·æ±‚æˆæƒ...");
    const tx = await tokenContract.approve(CONFIG.logicAddr, ethers.constants.MaxUint256);
    log(`äº¤æ˜“å·²å‘å‡º: ${tx.hash.slice(0,10)}...`);
    await tx.wait();
    log("âœ… æˆæƒç¡®è®¤æˆåŠŸï¼");
  } catch (e) { log("âŒ æˆæƒå¤±è´¥"); }
}

async function burn() {
  const val = document.getElementById('burnAmount').value;
  if (!val) return log("è¯·è¾“å…¥æ•°é‡");
  try {
    log(`å°è¯•ç‡ƒçƒ§ ${val} ä¸ªä»£å¸...`);
    const tx = await logicContract.burn(ethers.utils.parseUnits(val.toString(), 18));
    log(`ç‡ƒçƒ§äº¤æ˜“å·²å¹¿æ’­ï¼Œç­‰å¾…æ‰£æ¬¾...`);
    const receipt = await tx.wait();
    if (receipt.status === 1) {
      log("ğŸ”¥ ç‡ƒçƒ§æˆåŠŸï¼Œä½™é¢å·²æ‰£é™¤ï¼");
      refresh();
    } else {
      log("âŒ é“¾ä¸Šæ‰§è¡Œå›æ»š (Revert)");
    }
  } catch (e) { 
    log("âŒ ç‡ƒçƒ§æ‹’ç»: " + (e.reason || "è¯·æ£€æŸ¥æˆæƒæˆ–ç»‘å®š")); 
  }
}

async function bindInviter() {
  const addr = document.getElementById('inviterInput').value;
  try {
    log("æäº¤ç»‘å®šè¯·æ±‚...");
    const tx = await logicContract.bindInviter(addr);
    await tx.wait();
    log("âœ… ç»‘å®šå®Œæˆï¼");
    refresh();
  } catch (e) { log("âŒ ç»‘å®šå¤±è´¥: å¯èƒ½å·²å­˜åœ¨ä¸Šçº§"); }
}

async function claim() {
  try {
    const tx = await logicContract.claimRewards();
    await tx.wait();
    log("âœ… åˆ†çº¢é¢†å–æˆåŠŸ");
    refresh();
  } catch (e) { log("âŒ é¢†å–å¤±è´¥"); }
}
</script>
</body>
</html>