<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ç‡ƒçƒ§ç‹ğŸ”¥ğŸ”¥ğŸ”¥ | ç»ˆæDApp</title>
<script src="https://cdn.bootcdn.net/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif}
  body{background:#0a0a0a;color:#fff;padding:15px;padding-bottom:40px;}
  .container{max-width:480px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;padding:18px 0;border-bottom:1px solid #222}
  .logo{font-size:22px;font-weight:700;color:#ff3d3d}
  button{transition: all 0.2s ease;}
  button:disabled{background:#333 !important; color:#888 !important; cursor:not-allowed !important;}
  #connectBtn{background:#ff3d3d;color:#fff;border:none;padding:10px 16px;border-radius:12px;font-weight:700;cursor:pointer}
  .card{background:#121212;border-radius:20px;padding:24px;margin:16px 0;border:1px solid #222}
  .card h3{color:#ff3d3d;margin-bottom:18px;font-size:18px;display:flex;align-items:center}
  .balance{color:#aaa;margin-bottom:12px; display:flex; justify-content:space-between; font-size:14px}
  .input-group{position:relative;margin-bottom:10px}
  input{width:100%;background:#1a1a1a;border:1px solid #333;border-radius:14px;padding:16px;color:#fff;font-size:16px;outline:0}
  input:focus{border-color:#ff3d3d}
  .quick-btns{display:flex;gap:8px;margin-bottom:15px}
  .quick-btns button{flex:1;background:#222;color:#fff;border:none;padding:10px;border-radius:10px;font-size:13px;cursor:pointer}
  .btn-group{display:flex;gap:10px}
  .main-btn{width:100%;background:#ff3d3d;color:#fff;border:none;padding:16px;border-radius:14px;font-weight:700;font-size:16px;cursor:pointer;margin-top:5px}
  .invite-box{margin-top:15px; padding:15px; background:#1a1a1a; border-radius:14px; border:1px dashed #444;}
  .copy-btn{background:#333; color:#fff; padding:12px; border-radius:10px; border:none; width:100%; margin-top:10px; font-size:13px; cursor:pointer;}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid-item{background:#1a1a1a;padding:16px;border-radius:12px;font-size:13px;color:#aaa}
  .grid-item strong{color:#ff3d3d;font-size:18px; display:block; margin-top:6px;}
  .status{margin-top:16px;padding:12px;border-radius:10px;text-align:center; display:none; font-size:13px; word-break:break-all; line-height:1.4}
  .status.info{background:#132a45;color:#90caf9; display:block;}
  .status.success{background:#153a25;color:#81c784; display:block;}
  .status.error{background:#3a1518;color:#e57373; display:block;}
</style>
</head>
<body>
<div class="container">
<header>
  <div class="logo">ğŸ”¥ ç‡ƒçƒ§ç‹ DApp</div>
  <button id="connectBtn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
</header>

<div class="card">
  <h3>ğŸ”¥ æˆæƒä¸ç‡ƒçƒ§</h3>
  <div class="balance"><span id="balanceTxt">å¯ç”¨ä½™é¢ï¼š--</span></div>
  
  <div class="input-group">
    <input type="number" id="burnAmount" placeholder="è¾“å…¥ç‡ƒçƒ§æ•°é‡">
  </div>
  <div class="quick-btns">
    <button onclick="setQuickAmount(0.1)">10%</button>
    <button onclick="setQuickAmount(0.5)">50%</button>
    <button onclick="setQuickAmount(1)">MAX</button>
  </div>

  <div class="btn-group">
    <button class="main-btn" id="approveBtn" onclick="approve()">1. æˆæƒ(Approve)</button>
    <button class="main-btn" id="burnBtn" onclick="burn()">2. ç‡ƒçƒ§(Burn)</button>
  </div>
  <div id="status" class="status"></div>
</div>

<div class="card">
  <h3>ğŸ‘¥ é‚€è¯·ä¸ç»‘å®š</h3>
  <input type="text" id="inviter" placeholder="è¾“å…¥é‚€è¯·äººé’±åŒ…åœ°å€ (0x...)">
  <button class="main-btn" id="bindBtn" onclick="bindInviter()">ç¡®è®¤ç»‘å®šé‚€è¯·äºº</button>
  
  <div class="invite-box">
      <p style="font-size:12px; color:#aaa; margin-bottom:8px;">æ‚¨çš„ä¸“å±è£‚å˜é“¾æ¥ï¼š</p>
      <code id="myLinkDisplay" style="font-size:11px; color:#ff3d3d; word-break:break-all;">è¯·å…ˆè¿æ¥é’±åŒ…è·å–é“¾æ¥</code>
      <button class="copy-btn" onclick="copyInviteLink()">ğŸ”— ä¸€é”®å¤åˆ¶é“¾æ¥å‘é€å¥½å‹</button>
  </div>
</div>

<div class="card">
  <h3>ğŸ“Š æ”¶ç›Šé¢æ¿</h3>
  <div class="grid">
    <div class="grid-item">å¾…é¢†å–åˆ†çº¢<strong id="myReward">-- BNB</strong></div>
    <button class="main-btn" onclick="claim()" style="height:100%;margin:0;background:#2a2a2a">ä¸€é”®é¢†å–</button>
  </div>
</div>
</div>

<script>
// ================= æ ¸å¿ƒé…ç½®åŒº =================
const CONFIG = {
  chainId: 56,
  tokenAddr: "0x1382992c4f997a21256be58dc546e9937a5f7777", // ä»£å¸è´¦æœ¬
  logicAddr: "0xe3115d9dad43e47e9ae54d3cef1001aa34d8e602"  // ä¸šåŠ¡é€»è¾‘
};

const ABI = [
  "function decimals() view returns (uint8)",
  "function balanceOf(address) view returns (uint256)",
  "function approve(address, uint256) returns (bool)",
  "function burn(uint256)",
  "function bindInviter(address)",
  "function claimRewards()",
  "function pendingRewards(address) view returns (uint256)"
];

let provider, signer, userAddress, tokenContract, logicContract;
let tokenDecimals = 18; // é»˜è®¤ç²¾åº¦ï¼Œåç»­åŠ¨æ€è¯»å–
let rawBalance = ethers.BigNumber.from(0); // ä¿å­˜åŸå§‹ä½™é¢ç”¨äºç²¾ç¡®è®¡ç®—

// åˆå§‹åŒ–ï¼šè§£æé‚€è¯·é“¾æ¥å‚æ•°
window.onload = () => {
  const params = new URLSearchParams(window.location.search);
  const ref = params.get('ref');
  if (ref && ethers.utils.isAddress(ref)) {
    document.getElementById('inviter').value = ref;
  }
};

// ç›‘å¬é’±åŒ…è´¦å·/ç½‘ç»œåˆ‡æ¢ (é˜²å‘†è®¾è®¡)
if (window.ethereum) {
  window.ethereum.on('accountsChanged', () => window.location.reload());
  window.ethereum.on('chainChanged', () => window.location.reload());
}

function showStatus(text, type) {
  const s = document.getElementById('status');
  s.textContent = text;
  s.className = 'status ' + type;
  setTimeout(() => { if(s.textContent === text) s.style.display = 'none'; }, 6000); // 6ç§’åè‡ªåŠ¨éšè—
}

function setBtnState(id, disabled) {
  document.getElementById(id).disabled = disabled;
}

async function connectWallet() {
  if (!window.ethereum) return alert('è¯·åœ¨ TokenPocket æˆ– MetaMask é’±åŒ…æµè§ˆå™¨å†…æ‰“å¼€');
  try {
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    const net = await provider.getNetwork();
    if (net.chainId !== CONFIG.chainId) return alert('è¯·åˆ‡æ¢é’±åŒ…ç½‘ç»œè‡³ BSC ä¸»ç½‘');
    
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    
    tokenContract = new ethers.Contract(CONFIG.tokenAddr, ABI, signer);
    logicContract = new ethers.Contract(CONFIG.logicAddr, ABI, signer);
    
    document.getElementById('connectBtn').textContent = userAddress.slice(0,6) + '...' + userAddress.slice(-4);
    document.getElementById('myLinkDisplay').textContent = window.location.origin + window.location.pathname + "?ref=" + userAddress;
    
    // åŠ¨æ€è¯»å–ç²¾åº¦
    tokenDecimals = await tokenContract.decimals().catch(() => 18);
    refresh();
  } catch(e) { showStatus('é’±åŒ…è¿æ¥å¤±è´¥', 'error'); }
}

async function refresh() {
  if (!tokenContract) return;
  try {
    rawBalance = await tokenContract.balanceOf(userAddress);
    document.getElementById('balanceTxt').textContent = `å¯ç”¨ä½™é¢ï¼š${ethers.utils.formatUnits(rawBalance, tokenDecimals)}`;
    
    const pending = await logicContract.pendingRewards(userAddress).catch(()=>0);
    document.getElementById('myReward').textContent = parseFloat(ethers.utils.formatEther(pending)).toFixed(6) + ' BNB';
  } catch (e) { console.error(e); }
}

function setQuickAmount(percent) {
  if (rawBalance.eq(0)) return;
  // é¿å…æµ®ç‚¹æ•°è®¡ç®—å¯¼è‡´çš„ç²¾åº¦ä¸¢å¤±
  const amountStr = ethers.utils.formatUnits(rawBalance, tokenDecimals);
  const targetAmount = (parseFloat(amountStr) * percent).toFixed(6);
  document.getElementById('burnAmount').value = targetAmount;
}

async function approve() {
  setBtnState('approveBtn', true);
  try {
    showStatus('æ­£åœ¨å‘èµ·æˆæƒè¯·æ±‚...', 'info');
    const tx = await tokenContract.approve(CONFIG.logicAddr, ethers.constants.MaxUint256);
    await tx.wait();
    showStatus('âœ… æˆæƒæˆåŠŸï¼Œå¯æ‰§è¡Œç‡ƒçƒ§', 'success');
  } catch (e) { 
    showStatus('âŒ æˆæƒè¢«å–æ¶ˆæˆ–å¤±è´¥', 'error'); 
  } finally { setBtnState('approveBtn', false); }
}

async function burn() {
  const val = document.getElementById('burnAmount').value;
  if (!val || parseFloat(val) <= 0) return showStatus('è¯·è¾“å…¥æœ‰æ•ˆç‡ƒçƒ§æ•°é‡', 'error');
  
  setBtnState('burnBtn', true);
  try {
    showStatus('æ­£åœ¨ä¸ä¸šåŠ¡åˆçº¦äº¤äº’è¿›è¡Œç‡ƒçƒ§...', 'info');
    const amountToBurn = ethers.utils.parseUnits(val.toString(), tokenDecimals);
    const tx = await logicContract.burn(amountToBurn);
    await tx.wait();
    showStatus('ğŸ”¥ ç‡ƒçƒ§æˆåŠŸï¼', 'success');
    document.getElementById('burnAmount').value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
    refresh();
  } catch (e) { 
    const msg = e.reason || e.message;
    showStatus('âŒ äº¤æ˜“å¤±è´¥: ' + msg, 'error'); 
  } finally { setBtnState('burnBtn', false); }
}

async function bindInviter() {
  const addr = document.getElementById('inviter').value.trim();
  if (!ethers.utils.isAddress(addr)) return showStatus('é‚€è¯·äººåœ°å€æ ¼å¼ä¸æ­£ç¡®', 'error');
  if (addr.toLowerCase() === userAddress.toLowerCase()) return showStatus('ä¸èƒ½ç»‘å®šè‡ªå·±', 'error');

  setBtnState('bindBtn', true);
  try {
    showStatus('æ­£åœ¨å‘èµ·ç»‘å®šè¯·æ±‚...', 'info');
    const tx = await logicContract.bindInviter(addr);
    await tx.wait();
    showStatus('âœ… ç»‘å®šæˆåŠŸï¼', 'success');
  } catch (e) { 
    showStatus('âŒ ç»‘å®šå¤±è´¥: åˆçº¦æ‹’ç»æ‰§è¡Œ (å¯èƒ½å·²ç»‘å®š)', 'error'); 
  } finally { setBtnState('bindBtn', false); }
}

async function claim() {
  try {
    const tx = await logicContract.claimRewards();
    await tx.wait();
    alert('åˆ†çº¢é¢†å–æˆåŠŸï¼');
    refresh();
  } catch (e) { alert('é¢†å–å¤±è´¥æˆ–æ— å¾…é¢†å–åˆ†çº¢'); }
}

// å·¥ä¸šçº§å…¼å®¹æ€§å¤åˆ¶å‡½æ•°
function copyInviteLink() {
  const link = document.getElementById('myLinkDisplay').textContent;
  if (link.includes('è¯·å…ˆè¿æ¥')) return alert('è¯·å…ˆè¿æ¥é’±åŒ…');
  
  const textArea = document.createElement("textarea");
  textArea.value = link;
  textArea.style.position = "fixed";
  textArea.style.left = "-9999px";
  document.body.appendChild(textArea);
  textArea.select();
  try {
    document.execCommand('copy');
    alert('âœ… ä¸“å±è£‚å˜é“¾æ¥å·²å¤åˆ¶ï¼å¿«å»å‘é€ç»™å¥½å‹å§');
  } catch (err) { 
    alert("è‡ªåŠ¨å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰é¡µé¢çº¢è‰²é“¾æ¥å¤åˆ¶"); 
  }
  document.body.removeChild(textArea);
}
</script>
</body>
</html>