<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ç‡ƒçƒ§ç‹ğŸ”¥ğŸ”¥ğŸ”¥ | BSCç‡ƒçƒ§åˆ†çº¢DApp</title>
<script src="https://cdn.bootcdn.net/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:"PingFang SC","Microsoft YaHei",sans-serif}
  body{background:#0a0a0a;color:#fff;padding:15px}
  .container{max-width:480px;margin:0 auto}
  header{display:flex;justify-content:space-between;align-items:center;padding:18px 0;border-bottom:1px solid #222}
  .logo{font-size:24px;font-weight:700;color:#ff3d3d}
  button{transition: all 0.2s ease;}
  button:disabled{background:#333 !important; color:#888 !important; cursor:not-allowed !important;}
  #connectBtn{background:#ff3d3d;color:#fff;border:none;padding:11px 18px;border-radius:12px;font-weight:700;cursor:pointer}
  .card{background:#121212;border-radius:20px;padding:24px;margin:16px 0;border:1px solid #222}
  .card h3{color:#ff3d3d;margin-bottom:18px;font-size:18px}
  .balance{color:#aaa;margin-bottom:12px; display:flex; justify-content:space-between;}
  input{width:100%;background:#1a1a1a;border:1px solid #333;border-radius:14px;padding:16px;color:#fff;font-size:16px;outline:0;margin-bottom:10px}
  input:focus{border-color:#ff3d3d}
  .quick{display:flex;gap:8px;margin-bottom:12px}
  .quick button{flex:1;background:#222;color:#fff;border:none;padding:12px;border-radius:10px;cursor:pointer}
  .btn-group{display:flex;gap:10px;margin-top:10px}
  .main-btn{flex:1;background:#ff3d3d;color:#fff;border:none;padding:16px;border-radius:14px;font-weight:700;cursor:pointer}
  .copy-btn{background:#333; color:#fff; padding:10px; border-radius:10px; border:none; width:100%; margin-top:10px; font-size:12px; cursor:pointer;}
  .warn{color:#ffbb00;font-size:12px;margin-top:10px}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
  .grid-item{background:#1a1a1a;padding:16px;border-radius:12px}
  .grid-item strong{color:#ff3d3d;font-size:16px; display:block; margin-top:4px;}
  .status{margin-top:16px;padding:12px;border-radius:10px;text-align:center; display:none;}
  .status.info{background:#132a45;color:#90caf9; display:block;}
  .status.success{background:#153a25;color:#81c784; display:block;}
  .status.error{background:#3a1518;color:#e57373; display:block;}
  .invite-box{margin-top:15px; padding:15px; background:#1a1a1a; border-radius:14px; border:1px dashed #444;}
</style>
</head>
<body>
<div class="container">
<header>
  <div class="logo">ç‡ƒçƒ§ç‹ğŸ”¥ğŸ”¥ğŸ”¥</div>
  <button id="connectBtn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
</header>

<div class="card">
  <h3>ğŸ”¥ ç‡ƒçƒ§é”€æ¯ Â· å…¨ç½‘åˆ†çº¢</h3>
  <div class="balance"><span id="balanceTxt">ä½™é¢ï¼š--</span><span id="symbolTxt"></span></div>
  <input type="number" id="burnAmount" placeholder="è¾“å…¥ç‡ƒçƒ§æ•°é‡">
  <div class="quick">
    <button onclick="setQuick(10)">10%</button>
    <button onclick="setQuick(50)">50%</button>
    <button onclick="setQuick(100)">MAX</button>
  </div>
  <div class="btn-group">
    <button class="main-btn" id="approveBtn" onclick="approve()">1. æˆæƒ</button>
    <button class="main-btn" id="burnBtn" onclick="burn()">2. ç¡®è®¤ç‡ƒçƒ§</button>
  </div>
  <div id="status" class="status"></div>
</div>

<div class="card">
  <h3>ğŸ‘¥ é‚€è¯·ç»‘å®š (å¿…å¡«)</h3>
  <input type="text" id="inviter" placeholder="è¾“å…¥é‚€è¯·äººåœ°å€ (0x...)">
  <button class="main-btn" id="bindBtn" onclick="bindInviter()" style="width:100%;">ç¡®è®¤ç»‘å®šé‚€è¯·äºº</button>
  
  <div class="invite-box">
      <p style="font-size:12px; color:#aaa; margin-bottom:8px;">æ‚¨çš„ä¸“å±é‚€è¯·é“¾æ¥ï¼š</p>
      <code id="myLinkDisplay" style="font-size:11px; color:#ff3d3d; word-break:break-all;">è¿æ¥é’±åŒ…åæŸ¥çœ‹</code>
      <button class="copy-btn" id="copyBtn" onclick="copyLink()">ä¸€é”®å¤åˆ¶é“¾æ¥å‘é€å¥½å‹</button>
  </div>
  <p class="warn">æç¤ºï¼šç»‘å®šæˆåŠŸåæ–¹å¯æ‰§è¡Œç‡ƒçƒ§æ“ä½œã€‚</p >
</div>

<div class="card">
  <h3>ğŸ“Š å…¨ç½‘æ•°æ®</h3>
  <div class="grid">
    <div class="grid-item">æ€»ç‡ƒçƒ§<strong id="totalBurn">--</strong></div>
    <div class="grid-item">ç‡ƒçƒ§äººæ•°<strong id="burnUsers">--</strong></div>
    <div class="grid-item">ä»Šæ—¥ç‡ƒçƒ§<strong id="todayBurn">--</strong></div>
    <div class="grid-item">æˆ‘çš„åˆ†çº¢<strong id="myReward">-- BNB</strong></div>
  </div>
  <button class="main-btn" id="claimBtn" onclick="claim()" style="width:100%;margin-top:16px">é¢†å–åˆ†çº¢</button>
</div>

</div>

<script>
const CONFIG = {
  chainId: 56,
  tokenAddress: "0xe8803797e060a45cdf5b45249c3316da5bd87777" // è¯·ç¡®ä¿æ­¤åœ°å€åŒ…å« burn å’Œ bindInviter å‡½æ•°
};

const ABI = [
  "function decimals() view returns (uint8)",
  "function symbol() view returns (string)",
  "function balanceOf(address) view returns (uint256)",
  "function allowance(address, address) view returns (uint256)",
  "function approve(address, uint256) returns (bool)",
  "function burn(uint256)",
  "function bindInviter(address)",
  "function claimRewards()",
  "function totalBurned() view returns (uint256)",
  "function todayBurn() view returns (uint256)",
  "function burnerCount() view returns (uint256)",
  "function pendingRewards(address) view returns (uint256)"
];

let provider, signer, userAddress, contract, decimals = 18;

// 1. åˆå§‹åŒ–ï¼šè‡ªåŠ¨è§£æ URL é‡Œçš„é‚€è¯·äººå‚æ•° (?ref=0x...)
window.onload = () => {
  const params = new URLSearchParams(window.location.search);
  const ref = params.get('ref');
  if (ref && ethers.utils.isAddress(ref)) {
    document.getElementById('inviter').value = ref;
  }
};

function showStatus(text, type) {
  const s = document.getElementById('status');
  s.textContent = text;
  s.className = 'status ' + type;
}

async function connectWallet() {
  if (!window.ethereum) return showStatus('æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œè¯·åœ¨DAppæµè§ˆå™¨æ‰“å¼€', 'error');
  try {
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    provider = new ethers.providers.Web3Provider(window.ethereum);
    const net = await provider.getNetwork();
    if (net.chainId !== CONFIG.chainId) return showStatus('è¯·åˆ‡æ¢è‡³BSCä¸»ç½‘', 'error');
    
    signer = provider.getSigner();
    userAddress = await signer.getAddress();
    contract = new ethers.Contract(CONFIG.tokenAddress, ABI, signer);
    
    document.getElementById('connectBtn').textContent = userAddress.slice(0,6)+'...'+userAddress.slice(-4);
    
    // ç”Ÿæˆå¹¶æ˜¾ç¤ºé‚€è¯·é“¾æ¥
    const myLink = window.location.origin + window.location.pathname + "?ref=" + userAddress;
    document.getElementById('myLinkDisplay').textContent = myLink;
    
    refresh();
  } catch (e) { showStatus('è¿æ¥å¤±è´¥', 'error'); }
}

async function refresh() {
  if (!contract) return;
  try {
    decimals = await contract.decimals().catch(() => 18);
    const bal = await contract.balanceOf(userAddress);
    document.getElementById('balanceTxt').textContent = `ä½™é¢ï¼š${ethers.utils.formatUnits(bal, decimals)}`;
    document.getElementById('symbolTxt').textContent = await contract.symbol().catch(() => "");
    
    document.getElementById('totalBurn').textContent = ethers.utils.formatUnits(await contract.totalBurned().catch(()=>0), decimals);
    document.getElementById('burnUsers').textContent = (await contract.burnerCount().catch(()=>0)).toString();
    const pending = await contract.pendingRewards(userAddress).catch(()=>0);
    document.getElementById('myReward').textContent = ethers.utils.formatEther(pending) + ' BNB';
  } catch (e) { console.error(e); }
}

function setQuick(p) {
  const txt = document.getElementById('balanceTxt').textContent.split('ï¼š')[1];
  if (!txt || txt === '--') return;
  const amount = parseFloat(txt) * p / 100;
  document.getElementById('burnAmount').value = amount.toFixed(4);
}

async function approve() {
  const btn = document.getElementById('approveBtn');
  try {
    btn.disabled = true;
    showStatus('æ­£åœ¨è¯·æ±‚æˆæƒ...', 'info');
    const tx = await contract.approve(CONFIG.tokenAddress, ethers.constants.MaxUint256);
    await tx.wait();
    showStatus('æˆæƒæˆåŠŸï¼', 'success');
  } catch (e) { showStatus('æˆæƒå¤±è´¥', 'error'); }
  finally { btn.disabled = false; }
}

async function burn() {
  const btn = document.getElementById('burnBtn');
  const val = document.getElementById('burnAmount').value;
  if (!val || val <= 0) return showStatus('è¯·è¾“å…¥æ•°é‡', 'error');
  try {
    btn.disabled = true;
    showStatus('æ­£åœ¨ç‡ƒçƒ§...', 'info');
    const tx = await contract.burn(ethers.utils.parseUnits(val.toString(), decimals));
    await tx.wait();
    showStatus('ç‡ƒçƒ§æˆåŠŸï¼Œåˆ†çº¢å·²ç´¯è®¡', 'success');
    refresh();
  } catch (e) { showStatus('äº¤æ˜“å¤±è´¥ï¼šè¯·ç¡®è®¤å·²ç»‘å®šé‚€è¯·äººä¸”åˆçº¦æ”¯æŒæ­¤åŠŸèƒ½', 'error'); }
  finally { btn.disabled = false; }
}

async function bindInviter() {
  const btn = document.getElementById('bindBtn');
  const addr = document.getElementById('inviter').value.trim();
  if (!ethers.utils.isAddress(addr)) return showStatus('é‚€è¯·äººåœ°å€æ— æ•ˆ', 'error');
  try {
    btn.disabled = true;
    showStatus('æ­£åœ¨ç»‘å®š...', 'info');
    const tx = await contract.bindInviter(addr);
    await tx.wait();
    showStatus('ç»‘å®šæˆåŠŸï¼', 'success');
  } catch (e) { showStatus('ç»‘å®šå¤±è´¥ï¼šå¯èƒ½å·²ç»‘å®šæˆ–åˆçº¦é€»è¾‘é™åˆ¶', 'error'); }
  finally { btn.disabled = false; }
}

async function claim() {
  try {
    showStatus('æ­£åœ¨é¢†å–...', 'info');
    const tx = await contract.claimRewards();
    await tx.wait();
    showStatus('é¢†å–æˆåŠŸ', 'success');
    refresh();
  } catch (e) { showStatus('é¢†å–å¤±è´¥', 'error'); }
}

function copyLink() {
  const link = document.getElementById('myLinkDisplay').textContent;
  if (!userAddress) return showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
  navigator.clipboard.writeText(link).then(() => {
    showStatus('é“¾æ¥å·²å¤åˆ¶', 'success');
  }).catch(() => {
    alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰é“¾æ¥å¤åˆ¶");
  });
}
</script>
</body>
</html>