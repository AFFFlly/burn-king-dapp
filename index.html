<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ç‡ƒçƒ§ç‹ | 1-2-3 æ ‡å‡†æ“ä½œç‰ˆ</title>
<script src="https://cdn.bootcdn.net/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box;font-family:sans-serif}
  body{background:#0a0a0a;color:#fff;padding:15px}
  .container{max-width:480px;margin:0 auto}
  .card{background:#121212;border-radius:20px;padding:22px;margin:15px 0;border:1px solid #222}
  .step-num{background:#ff3d3d;color:#fff;width:24px;height:24px;border-radius:50%;display:inline-flex;justify-content:center;align-items:center;margin-right:8px;font-size:14px;font-weight:700}
  .logo{font-size:22px;font-weight:700;color:#ff3d3d;text-align:center;margin-bottom:10px}
  #connectBtn{background:#ff3d3d;color:#fff;border:none;padding:12px;border-radius:12px;width:100%;font-weight:700;cursor:pointer}
  input{width:100%;background:#1a1a1a;border:1px solid #333;border-radius:14px;padding:16px;color:#fff;font-size:16px;margin:10px 0}
  .main-btn{width:100%;background:#ff3d3d;color:#fff;border:none;padding:18px;border-radius:16px;font-weight:700;cursor:pointer;margin-top:10px}
  .main-btn:disabled{background:#333;color:#888;cursor:not-allowed}
  .debug-box{background:#000;padding:12px;border-radius:10px;font-family:monospace;font-size:11px;color:#00ff00;margin-top:15px;max-height:150px;overflow-y:auto;border:1px solid #333}
</style>
</head>
<body>
<div class="container">
  <div class="logo">ğŸ”¥ ç‡ƒçƒ§ç‹ Â· æ ¸å¿ƒç³»ç»Ÿ</div>
  <button id="connectBtn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>

  <div class="card">
    <h3><span class="step-num">1</span> ç»‘å®šé‚€è¯·äºº</h3>
    <input type="text" id="inviterInput" placeholder="è¾“å…¥é‚€è¯·äººåœ°å€ 0x...">
    <button class="main-btn" id="bindBtn" onclick="executeBind()">æ‰§è¡Œç»‘å®š</button>
  </div>

  <div class="card">
    <h3><span class="step-num">2</span> æˆæƒé¢åº¦</h3>
    <div style="font-size:13px;color:#aaa;margin-bottom:10px">å½“å‰ä½™é¢ï¼š<strong id="balanceShow">--</strong></div>
    <button class="main-btn" id="approveBtn" onclick="executeApprove()">ç‚¹å‡»æˆæƒ</button>
  </div>

  <div class="card">
    <h3><span class="step-num">3</span> ç¡®è®¤ç‡ƒçƒ§</h3>
    <input type="number" id="burnAmount" placeholder="è¾“å…¥ç‡ƒçƒ§æ•°é‡">
    <button class="main-btn" id="burnBtn" onclick="executeBurn()">ç«‹å³ç‡ƒçƒ§</button>
  </div>

  <div class="debug-box" id="debugLog">> è¯·è¿æ¥é’±åŒ…å¹¶æŒ‰ç…§ 1 -> 2 -> 3 é¡ºåºæ“ä½œ</div>
</div>

<script>
const CONFIG = {
  chainId: 56,
  tokenAddr: "0x1382992c4f997a21256be58dc546e9937a5f7777", // ä½™é¢
  logicAddr: "0xe3115d9dad43e47e9ae54d3cef1001aa34d8e602"  // ä¸šåŠ¡
};

const ABI = [
  "function balanceOf(address) view returns (uint256)",
  "function approve(address, uint256) returns (bool)",
  "function burn(uint256)",
  "function bindInviter(address)",
  "function inviter(address) view returns (address)"
];

let signer, userAddress, tokenContract, logicContract;

function log(msg) {
  const box = document.getElementById('debugLog');
  box.innerHTML += `<br>> ${msg}`;
  box.scrollTop = box.scrollHeight;
}

async function connectWallet() {
  if (!window.ethereum) return alert('è¯·åœ¨é’±åŒ…å†…æ‰“å¼€');
  const provider = new ethers.providers.Web3Provider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = provider.getSigner();
  userAddress = await signer.getAddress();
  tokenContract = new ethers.Contract(CONFIG.tokenAddr, ABI, signer);
  logicContract = new ethers.Contract(CONFIG.logicAddr, ABI, signer);
  document.getElementById('connectBtn').textContent = userAddress.slice(0,6)+'...'+userAddress.slice(-4);
  log(`é’±åŒ…å·²è¿æ¥: ${userAddress}`);
  refresh();
}

async function refresh() {
  try {
    const bal = await tokenContract.balanceOf(userAddress);
    document.getElementById('balanceShow').textContent = ethers.utils.formatUnits(bal, 18);
  } catch (e) { log("çŠ¶æ€åŒæ­¥å¼‚å¸¸"); }
}

async function executeBind() {
  const addr = document.getElementById('inviterInput').value;
  if (!ethers.utils.isAddress(addr)) return log("æ— æ•ˆåœ°å€");
  try {
    log("æ­£åœ¨æ‰§è¡Œç¬¬1æ­¥ï¼šç»‘å®šé‚€è¯·äºº...");
    const tx = await logicContract.bindInviter(addr);
    await tx.wait();
    log("âœ… ç¬¬1æ­¥ç»‘å®šæˆåŠŸï¼è¯·æ‰§è¡Œç¬¬2æ­¥æˆæƒã€‚");
  } catch (e) { log("âŒ ç»‘å®šå¤±è´¥ï¼Œå¯èƒ½å·²ç»‘å®šè¿‡"); }
}

async function executeApprove() {
  try {
    log("æ­£åœ¨æ‰§è¡Œç¬¬2æ­¥ï¼šæˆæƒä»£å¸...");
    const tx = await tokenContract.approve(CONFIG.logicAddr, ethers.constants.MaxUint256);
    await tx.wait();
    log("âœ… ç¬¬2æ­¥æˆæƒæˆåŠŸï¼è¯·æ‰§è¡Œç¬¬3æ­¥ç‡ƒçƒ§ã€‚");
  } catch (e) { log("âŒ æˆæƒå¤±è´¥"); }
}

async function executeBurn() {
  const val = document.getElementById('burnAmount').value;
  if (!val) return log("è¯·è¾“å…¥æ•°é‡");
  try {
    log("æ­£åœ¨æ‰§è¡Œç¬¬3æ­¥ï¼šå‘èµ·ç‡ƒçƒ§...");
    const tx = await logicContract.burn(ethers.utils.parseUnits(val.toString(), 18));
    log("äº¤æ˜“å·²å‘å‡ºï¼Œç­‰å¾…é“¾ä¸Šç¡®è®¤...");
    const receipt = await tx.wait();
    if (receipt.status === 1) {
      log("ğŸ”¥ ç‡ƒçƒ§å¤§åŠŸå‘Šæˆï¼ä½™é¢å·²æ‰£é™¤ã€‚");
      refresh();
    } else {
      log("âŒ é“¾ä¸Šæ‰§è¡Œå›æ»šï¼Œè¯·æ£€æŸ¥æ˜¯å¦å®Œæˆäº†å‰ä¸¤æ­¥");
    }
  } catch (e) { log("âŒ ç‡ƒçƒ§è¢«æ‹’ï¼Œè¯·ç¡®è®¤ 1ã€2 æ­¥å·²å®Œæˆ"); }
}
</script>
</body>
</html>